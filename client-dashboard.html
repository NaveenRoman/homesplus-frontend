<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Private Client Dashboard</title>

<style>
body{
    margin:0;
    font-family:Inter,sans-serif;
    background:linear-gradient(135deg,#1e3a8a,#2563eb);
}

/* LOGIN */
.access-box{
    background:white;
    padding:40px;
    border-radius:18px;
    box-shadow:0 25px 60px rgba(0,0,0,0.2);
    width:380px;
    text-align:center;
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
}
.access-box input{
    width:100%;
    padding:12px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #ddd;
}
.access-box button{
    width:100%;
    padding:12px;
    background:#2563eb;
    color:white;
    border:none;
    border-radius:8px;
}

/* DASHBOARD */
.dashboard{
    display:none;
    padding:40px;
    background:#f4f6fb;
    min-height:100vh;
}
.dashboard-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
}
.logout-btn{
    background:#ef4444;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:6px;
}

.card{
    background:white;
    padding:25px;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    margin-bottom:25px;
}
.card input,.card textarea,.card select{
    width:100%;
    padding:10px;
    margin:8px 0;
}
.card button{
    background:#16a34a;
    color:white;
    border:none;
    padding:12px;
    border-radius:8px;
    width:100%;
    margin-top:8px;
}

.success{color:green;}
.error{color:red;}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="access-box" id="loginBox">
<h2>Client Secure Access</h2>

<input type="text" id="clientName" placeholder="Full Name">
<input type="email" id="clientEmail" placeholder="Email">
<input type="password" id="accessCode" placeholder="Access Code">

<button id="accessBtn">Access Dashboard</button>
<p id="msg"></p>
</div>


<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">

<div class="dashboard-header">
    <h2>Private Dashboard</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- MENU -->
<div class="card" id="menuCard">
<h2>Dashboard Menu</h2>
<button onclick="showUpload()">üì§ Upload Property</button>
<button onclick="showVisitors()">üë• Visitor Data</button>
</div>

<!-- UPLOAD -->
<div class="card" id="uploadSection" style="display:none;">


<button onclick="goBack()" style="background:#2563eb;">‚Üê Back</button>

<h2>Add Property</h2>

<form id="propertyForm" enctype="multipart/form-data">

<input name="title" placeholder="Property Title" required>
<input name="location" placeholder="Location" required>

<select name="verified" required>
<option value="">Verification Status</option>
<option value="true">Verified</option>
<option value="false">Not Verified</option>
</select>

<input name="area" placeholder="Area">
<input name="type" placeholder="Property Type">
<input name="pricePerSqft" placeholder="Price/Sqft">
<input name="totalCost" placeholder="Total Cost">

<label>Cover Image</label>
<input type="file" name="coverImage" required>

<label>Media</label>
<input type="file" name="media" multiple>

<button type="submit">Save Property</button>
</form>

<p id="uploadMsg"></p>

<div id="progressBox" style="display:none;">
<strong id="uploadFileName"></strong>
<div style="background:#ddd;border-radius:8px;">
<div id="progressBar"
style="height:10px;width:0%;background:#16a34a;"></div>
</div>
<p id="progressText">0%</p>
</div>

</div>

<!-- VISITORS -->
<div class="card" id="visitorSection" style="display:none;">


<h2>Visitor Leads</h2>

<button onclick="exportToExcel()" style="background:#2563eb;">
Export to Excel
</button>

<table border="1" width="100%" id="visitorTable">
<thead>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Place</th>
<th>Property</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<script>
const SECRET_CODE="MGR2026";
const BACKEND_URL="https://homesplus-backend1-1.onrender.com";

/* ---------- LOGIN ---------- */
document.getElementById("accessBtn").addEventListener("click",()=>{

const name=document.getElementById("clientName").value.trim();
const email=document.getElementById("clientEmail").value.trim();
const code=document.getElementById("accessCode").value.trim();
const msg=document.getElementById("msg");

if(!name||!email||!code){
    msg.innerText="All fields required";
    msg.className="error";
    return;
}

if(code!==SECRET_CODE){
    msg.innerText="Invalid Access Code";
    msg.className="error";
    return;
}

localStorage.setItem("clientLoggedIn","true");
loadDashboard();
});

function loadDashboard(){
document.getElementById("loginBox").style.display="none";
document.getElementById("dashboard").style.display="block";

checkEditMode(); // ‚≠ê ADD THIS LINE
}


window.onload=()=>{
if(localStorage.getItem("clientLoggedIn")==="true"){
    loadDashboard();
}
};

function logout(){
localStorage.clear();
location.reload();
}

/* ---------- NAVIGATION ---------- */
function hideAll(){
document.getElementById("menuCard").style.display="none";
document.getElementById("uploadSection").style.display="none";
document.getElementById("visitorSection").style.display="none";
}

function showUpload(){
hideAll();
document.getElementById("uploadSection").style.display="block";
}

function showVisitors(){
hideAll();
document.getElementById("visitorSection").style.display="block";
loadVisitors();
}

function goBack(){
hideAll();
document.getElementById("menuCard").style.display="block";
}


/* ---------- EDIT MODE CHECK ---------- */
async function checkEditMode(){

const params = new URLSearchParams(window.location.search);
const editId = params.get("edit");

if(!editId) return;

showUpload(); // open upload section automatically

const form = document.getElementById("propertyForm");

try{

const res = await fetch(
`${BACKEND_URL}/api/properties/${editId}`
);

const property = await res.json();

/* AUTO FILL FORM */
form.title.value = property.title || "";
form.location.value = property.location || "";
form.area.value = property.area || "";
form.type.value = property.type || "";
form.pricePerSqft.value = property.pricePerSqft || "";
form.totalCost.value = property.totalCost || "";

/* STORE EDIT ID */
form.dataset.editId = editId;

/* CHANGE BUTTON TEXT */
form.querySelector("button[type='submit']")
.innerText = "Update Property";

}catch(err){
console.error("Edit load failed", err);
}

}


/* ---------- PROPERTY UPLOAD ---------- */
document.getElementById("propertyForm")
.addEventListener("submit",function(e){

e.preventDefault();

const formData=new FormData(this);
const xhr=new XMLHttpRequest();

document.getElementById("progressBox").style.display="block";

const cover=document.querySelector('input[name="coverImage"]').files[0];
if(cover){
document.getElementById("uploadFileName").innerText=
"Uploading: "+cover.name;
}

xhr.upload.onprogress=(e)=>{
if(e.lengthComputable){
const percent=Math.round((e.loaded/e.total)*100);
document.getElementById("progressBar").style.width=percent+"%";
document.getElementById("progressText").innerText=percent+"%";
}
};

xhr.onload=()=>{
if(xhr.status===200){
document.getElementById("uploadMsg").innerText=
"‚úÖ Property Saved Successfully!";
document.getElementById("uploadMsg").className="success";
this.reset();
setTimeout(goBack,1200);
}else{
document.getElementById("uploadMsg").innerText="‚ùå Upload Failed";
document.getElementById("uploadMsg").className="error";
}
};

const editId = this.dataset.editId;

if(editId){
xhr.open("PUT",
`${BACKEND_URL}/api/properties/${editId}`);
}else{
xhr.open("POST",
`${BACKEND_URL}/api/properties`);
}

xhr.send(formData);
});

/* ---------- VISITORS ---------- */
async function loadVisitors(){
const res=await fetch(`${BACKEND_URL}/api/visitors`);
const visitors=await res.json();

const tbody=document.querySelector("#visitorTable tbody");
tbody.innerHTML="";

visitors.forEach(v=>{
tbody.innerHTML+=`
<tr>
<td>${v.name}</td>
<td>${v.phone}</td>
<td>${v.place}</td>
<td>${v.propertyId}</td>
<td>${new Date(v.createdAt).toLocaleString()}</td>
<td>
<button onclick="deleteVisitor('${v._id}')"
style="background:#ef4444;color:white;border:none;padding:6px 10px;">
Delete
</button>
</td>
</tr>`;
});
}

async function deleteVisitor(id){
if(!confirm("Delete this visitor?")) return;

await fetch(`${BACKEND_URL}/api/visitors/${id}`,{
method:"DELETE"
});

loadVisitors();
}

/* ---------- EXPORT ---------- */
function exportToExcel(){
const table=document.getElementById("visitorTable");
const blob=new Blob([table.outerHTML],{
type:"application/vnd.ms-excel"
});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="visitor-leads.xls";
a.click();
}
</script>

</body>
</html>
